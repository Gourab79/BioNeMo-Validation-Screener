<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioAI | Professional Virtual Screening</title>
    <script src="https://unpkg.com/ngl@next/dist/ngl.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #09090b;
            --panel: #121214;
            --border: #27272a;
            --accent: #76b900;
            --accent-glow: rgba(118, 185, 0, 0.15);
            --text: #ffffff;
            --text-muted: #a1a1aa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevents body scroll */
        }

        /* --- HEADER PANEL (Fixed Height) --- */
        .header-panel {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            padding: 20px 30px;
            gap: 30px;
            height: 320px; /* Compacted slightly for more view space */
            min-height: 320px;
            z-index: 20;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .brand-block {
            width: 220px;
            border-right: 1px solid var(--border);
            padding-right: 20px;
            display: flex;
            flex-direction: column;
        }
        .brand-block h1 { font-size: 1.6rem; font-weight: 800; color: var(--accent); letter-spacing: -0.5px; margin-bottom: 5px; }
        .brand-block p { font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; }

        /* Inputs */
        .input-group { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .input-group label { 
            font-size: 0.7rem; color: var(--text-muted); font-weight: 700; 
            text-transform: uppercase; letter-spacing: 0.5px; 
        }
        
        textarea, input {
            background: #000;
            border: 1px solid var(--border);
            color: #fff;
            border-radius: 6px;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            resize: none;
            flex: 1;
            transition: border 0.2s;
        }
        textarea:focus, input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }

        .btn-primary {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 12px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-top: auto;
        }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* --- MAIN CONTENT (Flex Grow) --- */
        .viewer-area { 
            flex: 1; 
            display: flex; 
            position: relative; 
            overflow: hidden; /* Crucial for inner scrolling */
            min-height: 0; /* Flexbox scrolling fix */
        }

        /* Results Sidebar */
        .results-container {
            width: 360px;
            background: #161618;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: width 0.3s ease;
        }
        
        .results-container.collapsed { width: 0; border: none; overflow: hidden; }

        .results-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(22, 22, 24, 0.95);
        }
        .results-header h3 { font-size: 0.9rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }

        /* SCROLLABLE LIST */
        .results-list {
            flex: 1;
            overflow-y: auto; /* Enables scrolling */
            padding: 15px;
        }
        /* Custom Scrollbar */
        .results-list::-webkit-scrollbar { width: 6px; }
        .results-list::-webkit-scrollbar-track { background: #111; }
        .results-list::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .results-list::-webkit-scrollbar-thumb:hover { background: #555; }

        .result-card {
            background: #1f1f22;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .result-card:hover { border-color: var(--accent); background: #252528; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .card-title { font-weight: 700; font-size: 0.9rem; color: #fff; }
        .match-score { font-size: 0.75rem; background: var(--accent-glow); color: var(--accent); padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .card-desc { font-size: 0.75rem; color: var(--text-muted); line-height: 1.3; margin-bottom: 10px; display: block; }

        .btn-dock {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn-dock:hover { background: var(--accent); color: #000; border-color: var(--accent); }

        /* --- 3D VIEWER --- */
        #viewport { flex: 1; width: 100%; background: radial-gradient(circle at center, #1a1e26 0%, #000 100%); cursor: grab; }

        /* Floating Toolbar */
        .toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 15, 17, 0.9); backdrop-filter: blur(8px);
            padding: 8px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.15);
            display: flex; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 50;
        }
        
        .tool-btn {
            background: transparent; border: none; color: #fff; width: 40px; height: 40px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; transition: 0.2s; position: relative;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: var(--accent); }
        
        /* Tooltips */
        .tool-btn:after {
            content: attr(title); position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff; padding: 4px 8px; font-size: 0.7rem; border-radius: 4px;
            opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap; border: 1px solid #333;
        }
        .tool-btn:hover:after { opacity: 1; bottom: 55px; }

        .loader-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; 
            flex-direction: column; align-items: center; justify-content: center; z-index: 100; 
        }
        .spinner { width: 50px; height: 50px; border: 3px solid #333; border-top: 3px solid var(--accent); 
            border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Panel Toggle Button */
        .toggle-panel-btn {
            position: absolute; top: 20px; left: 20px; z-index: 40;
            background: var(--panel); border: 1px solid var(--border); color: #fff;
            width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .toggle-panel-btn:hover { border-color: var(--accent); color: var(--accent); }

    </style>
</head>
<body>

    <div class="header-panel">
        <div class="brand-block">
            <h1>BIOAI <span style="font-weight:400; opacity:0.5;">|</span> LAB</h1>
            <p>Virtual Screening & Molecular Docking Workstation</p>
            <div style="margin-top:auto; font-size:0.7rem; color:#555;">
                Engine: NVIDIA NIM<br>Library: RDKit + DiffDock
            </div>
        </div>

        <div class="input-group" style="flex:2;">
            <label>Target Protein (PDB Structure)</label>
            <textarea id="inp-pdb" placeholder="Paste full PDB file contents here (ATOM records required)..."></textarea>
        </div>

        <div class="input-group" style="flex:1.5;">
            <label>Query Ligand (SMILES)</label>
            <textarea id="screen-query" style="height:80px;" placeholder="e.g., COC(=O)c1ccccc1O">COC(=O)c1ccccc1O</textarea>
            
            <button class="btn-primary" onclick="runScreening()">
                <i class="ph-bold ph-magnifying-glass"></i> SCAN DATABASE
            </button>
        </div>
    </div>

    <div class="viewer-area" id="main-container">
        
        <div class="results-container" id="results-panel">
            <div class="results-header">
                <h3><i class="ph-fill ph-list-magnifying-glass"></i> CANDIDATES</h3>
                <button onclick="togglePanel()" style="background:none; border:none; color:#555; cursor:pointer;"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <div class="results-list" id="screen-results">
                <div style="text-align:center; padding:40px 20px; color:#444;">
                    <i class="ph ph-flask" style="font-size:2rem; margin-bottom:10px;"></i>
                    <p>Enter a query molecule and click SCAN to find docking candidates.</p>
                </div>
            </div>
        </div>

        <button class="toggle-panel-btn" onclick="togglePanel()" id="show-panel-btn" style="display:none;">
            <i class="ph-bold ph-list"></i>
        </button>

        <div id="viewport"></div>

        <div class="toolbar">
            <button class="tool-btn" onclick="resetView()" title="Reset View"><i class="ph ph-arrows-out-cardinal"></i></button>
            <button class="tool-btn" onclick="toggleSpin()" title="Auto Spin"><i class="ph ph-arrows-clockwise"></i></button>
            <button class="tool-btn" onclick="toggleFullScreen()" title="Full Screen"><i class="ph ph-corners-out"></i></button>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2);"></div>
            <button class="tool-btn" onclick="takeScreenshot()" title="HD Screenshot"><i class="ph ph-camera"></i></button>
            <button class="tool-btn" onclick="downloadData()" title="Download Structure"><i class="ph ph-download-simple"></i></button>
        </div>

        <div class="loader-overlay" id="loader">
            <div class="spinner"></div>
            <p style="margin-top:20px; color:#fff; font-weight:600; letter-spacing:1px;">CALCULATING DOCKING POSE...</p>
        </div>
    </div>

<script>
    let stage;
    let currentComp;
    let isSpinning = false;
    let currentData = null;
    let currentExt = 'sdf';

    document.addEventListener("DOMContentLoaded", () => {
        stage = new NGL.Stage("viewport", { backgroundColor: "#000", tooltip:true });
        stage.setParameters({ impostor: true, quality: "high" });
        stage.handleResize();
        window.addEventListener("resize", () => stage.handleResize());
        
        // Disable Zoom to prevent page scroll conflict
        stage.mouseControls.remove("scroll");
        stage.mouseControls.remove("pinch");
    });

    // --- UI FUNCTIONS ---
    function togglePanel() {
        const panel = document.getElementById('results-panel');
        const btn = document.getElementById('show-panel-btn');
        
        if (panel.classList.contains('collapsed')) {
            panel.classList.remove('collapsed');
            btn.style.display = 'none';
        } else {
            panel.classList.add('collapsed');
            btn.style.display = 'flex';
        }
        setTimeout(() => stage.handleResize(), 300);
    }

    function toggleFullScreen() {
        const elem = document.getElementById('main-container');
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => {
                alert(`Error attempting to enable full-screen mode: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // --- SCREENING LOGIC ---
    async function runScreening() {
        const query = document.getElementById('screen-query').value;
        const list = document.getElementById('screen-results');
        
        if(!query) return alert("Please enter a SMILES string.");

        list.innerHTML = '<p style="text-align:center; color:#76b900; margin-top:20px;">Searching database...</p>';

        try {
            const req = await fetch('/screen', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ query_smiles: query })
            });
            const data = await req.json();
            
            list.innerHTML = '';
            
            if(data.matches && data.matches.length > 0) {
                data.matches.forEach(m => {
                    const percent = (m.similarity * 100).toFixed(1);
                    const div = document.createElement('div');
                    div.className = 'result-card';
                    div.innerHTML = `
                        <div class="card-header">
                            <span class="card-title">${m.name}</span>
                            <span class="match-score">${percent}%</span>
                        </div>
                        <span class="card-desc">${m.desc || 'No description available.'}</span>
                        <button class="btn-dock" onclick="runDocking('${m.smiles}', '${m.name}')">
                            <i class="ph-bold ph-crosshair"></i> DOCK THIS MOLECULE
                        </button>
                    `;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = '<p style="text-align:center; color:#555;">No matches found.</p>';
            }
        } catch(e) {
            list.innerHTML = `<p style="color:red; padding:10px;">Error: ${e.message}</p>`;
        }
    }

    // --- DOCKING LOGIC ---
    async function runDocking(ligandSmiles, name) {
        const pdb = document.getElementById('inp-pdb').value;
        
        if(!pdb.includes("ATOM")) return alert("Please paste the full PDB protein structure first.");

        const loader = document.getElementById('loader');
        loader.style.display = 'flex';

        try {
            const res = await fetch('/predict/diffdock', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ pdb_string: pdb, smiles: ligandSmiles })
            });
            const data = await res.json();
            
            if(data.error) throw new Error(data.error);

            currentData = data.data;
            currentExt = data.type;
            
            loadVisualization(pdb, data.data, data.type);
            alert(`Docking Complete for ${name}`);

        } catch(e) {
            alert("Docking Failed: " + e.message);
        } finally {
            loader.style.display = 'none';
        }
    }

    // --- VISUALIZATION ---
    function loadVisualization(protein, ligand, ligType) {
        stage.removeAllComponents();
        
        // Load Protein
        const blobP = new Blob([protein], {type: 'text/plain'});
        stage.loadFile(blobP, { ext: 'pdb' }).then(c => {
            c.addRepresentation("cartoon", { colorScheme: "chainname", quality: "high" });
            c.addRepresentation("surface", { opacity:0.1, color:"white", side:"front" });
        });

        // Load Ligand
        const blobL = new Blob([ligand], {type: 'text/plain'});
        stage.loadFile(blobL, { ext: ligType }).then(c => {
            c.addRepresentation("licorice", { colorScheme: "element", scale: 2.0 }); // Thicker sticks
            c.addRepresentation("ball+stick", { colorScheme: "element", scale: 0.3 }); // Atoms
            stage.autoView(1500);
        });
    }

    // --- TOOLBAR ACTIONS ---
    function resetView() { stage.autoView(1000); }
    function toggleSpin() { isSpinning = !isSpinning; stage.setSpin(isSpinning); }
    
    function takeScreenshot() {
        stage.makeImage({ factor: 4, antialias: true, trim: false }).then(b => {
            NGL.download(b, "molecular_render.png");
        });
    }

    function downloadData() {
        if(!currentData) return alert("No docked structure to download.");
        const blob = new Blob([currentData], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `docked_complex.${currentExt}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>
</body>
</html>