<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioNeMo Studio | Multi-Model Architecture</title>
    <script src="https://unpkg.com/ngl@next/dist/ngl.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #09090b;
            --panel: #141417;
            --border: #27272a;
            --accent: #76b900;
            --accent-dim: rgba(118, 185, 0, 0.1);
            --text: #ffffff;
            --text-muted: #a1a1aa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR (Model Zoo) --- */
        .sidebar {
            width: 320px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 20;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }

        .brand {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand i { color: var(--accent); font-size: 1.5rem; }

        .category-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px 0;
        }

        .model-card {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-muted);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            margin-bottom: 5px;
            text-align: left;
        }
        
        .model-card:hover { background: rgba(255,255,255,0.03); color: var(--text); }
        
        .model-card.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--text);
        }
        
        .model-card i { font-size: 1.2rem; }

        /* --- MAIN AREA --- */
        .main-view { flex: 1; display: flex; flex-direction: column; position: relative; }

        /* Dynamic Input Panel */
        .input-panel {
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border);
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 220px;
            backdrop-filter: blur(10px);
        }

        .form-group { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }
        
        textarea, input {
            background: #000;
            border: 1px solid var(--border);
            color: #fff;
            border-radius: 6px;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            resize: none;
            flex: 1;
        }
        textarea:focus, input:focus { outline: none; border-color: var(--accent); }

        .action-col { width: 180px; display: flex; flex-direction: column; gap: 10px; justify-content: flex-end; }
        
        .btn-run {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 15px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: transform 0.1s;
        }
        .btn-run:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-run:disabled { background: #333; color: #555; cursor: not-allowed; transform: none; }

        /* 3D Viewport */
        #viewport { flex: 1; width: 100%; background: #000; cursor: move; }

        /* Floating Toolbar */
        .toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20,20,20,0.9); backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .tool-btn {
            background: rgba(255,255,255,0.05); border: none; color: #fff;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; transition: 0.2s;
        }
        .tool-btn:hover { background: var(--accent); color: #000; }

        /* Loader */
        .loader-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; backdrop-filter: blur(5px);
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #333;
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand">
        <i class="ph-fill ph-dna"></i> BioNeMo Studio
    </div>

    <div class="category-label">Structure Prediction</div>
    <button class="model-card active" onclick="setModel('openfold3')">
        <i class="ph ph-cube"></i>
        <div>
            <div style="font-weight:600;">OpenFold 3</div>
            <div style="font-size:0.7rem;">Protein Complexes</div>
        </div>
    </button>
    <button class="model-card" onclick="setModel('alphafold2')">
        <i class="ph ph-polygon"></i>
        <div>
            <div style="font-weight:600;">AlphaFold 2</div>
            <div style="font-size:0.7rem;">Standard Folding</div>
        </div>
    </button>

    <div class="category-label">Docking & Interaction</div>
    <button class="model-card" onclick="setModel('diffdock')">
        <i class="ph ph-magnet"></i>
        <div>
            <div style="font-weight:600;">DiffDock</div>
            <div style="font-size:0.7rem;">Drug-Protein Binding</div>
        </div>
    </button>

    <div class="category-label">Generative Chemistry</div>
    <button class="model-card" onclick="setModel('molmim')">
        <i class="ph ph-flask"></i>
        <div>
            <div style="font-weight:600;">MolMIM</div>
            <div style="font-size:0.7rem;">Molecule Generation</div>
        </div>
    </button>
</div>

<div class="main-view">
    
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#fff; font-weight:600;">Processing on NVIDIA H100...</p>
    </div>

    <div class="input-panel">
        <div id="dynamic-forms" style="flex:1; display:flex; gap:20px;">
            </div>
        <div class="action-col">
            <button class="btn-run" id="btn-run" onclick="executeModel()">
                <i class="ph-bold ph-lightning"></i> RUN
            </button>
        </div>
    </div>

    <div id="viewport"></div>

    <div class="toolbar">
        <button class="tool-btn" onclick="resetView()" title="Fit All"><i class="ph ph-arrows-out-cardinal"></i></button>
        <button class="tool-btn" onclick="toggleSpin()" title="Spin"><i class="ph ph-arrows-clockwise"></i></button>
        <div style="width:1px; background:rgba(255,255,255,0.2); margin:0 5px;"></div>
        <button class="tool-btn" onclick="takeScreenshot()" title="Screenshot"><i class="ph ph-camera"></i></button>
        <button class="tool-btn" onclick="downloadData()" title="Download"><i class="ph ph-download-simple"></i></button>
    </div>
</div>

<script>
    let currentModel = 'openfold3';
    let stage;
    let comp;
    let isSpinning = false;
    let currentData = null;
    let currentExt = 'pdb';

    // DEFAULTS
    const DEFAULTS = {
        of3: "MGREEPLNHVEAERQRREKLNQRFYALRAVVPNVSKMDKASLLGDAIAYINELKSKVVKTESEKLQIKNQLEEVKLELAGRLEHHHHHH",
        af2: "MAEPQVTDPTQGSEGRGSDLTGIPSDLVRWLRSHSGQ",
        molmim: "Cc1ccccc1", // Benzene ring
        dock_prot: "ATOM      1  N   ASP A   1      -6.845   1.467  -0.547  1.00  0.00           N",
        dock_lig: "CCO"
    };

    document.addEventListener("DOMContentLoaded", () => {
        stage = new NGL.Stage("viewport", { backgroundColor: "#000", tooltip:true });
        stage.setParameters({ impostor: true, quality: "high" });
        stage.handleResize();
        window.addEventListener("resize", () => stage.handleResize());
        
        // Disable Zoom logic as requested
        stage.mouseControls.remove("scroll");
        stage.mouseControls.remove("pinch");

        renderForm('openfold3');
    });

    // --- FORM LOGIC ---
    function setModel(model) {
        currentModel = model;
        document.querySelectorAll('.model-card').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        renderForm(model);
    }

    function renderForm(model) {
        const container = document.getElementById('dynamic-forms');
        container.innerHTML = ''; // Clear

        if(model === 'openfold3' || model === 'alphafold2') {
            const val = model === 'openfold3' ? DEFAULTS.of3 : DEFAULTS.af2;
            container.innerHTML = `
                <div class="form-group">
                    <label>Protein Sequence (Amino Acids)</label>
                    <textarea id="inp-seq" placeholder="MGREE...">${val}</textarea>
                </div>
            `;
        }
        else if(model === 'molmim') {
            container.innerHTML = `
                <div class="form-group">
                    <label>Seed Molecule (SMILES)</label>
                    <input type="text" id="inp-smiles" value="${DEFAULTS.molmim}">
                </div>
            `;
        }
        else if(model === 'diffdock') {
            container.innerHTML = `
                <div class="form-group">
                    <label>Protein Structure (PDB Text)</label>
                    <textarea id="inp-pdb" placeholder="PASTE PDB DATA HERE..."></textarea>
                </div>
                <div class="form-group">
                    <label>Ligand (SMILES)</label>
                    <input type="text" id="inp-ligand" value="${DEFAULTS.dock_lig}">
                </div>
            `;
        }
    }

    // --- API EXECUTION ---
    async function executeModel() {
        const btn = document.getElementById('btn-run');
        const loader = document.getElementById('loader');
        
        // Gather Payload
        let payload = {};
        
        if (currentModel === 'openfold3' || currentModel === 'alphafold2') {
            const seq = document.getElementById('inp-seq').value;
            if(!seq) return alert("Sequence required");
            payload = { sequence: seq };
        }
        else if (currentModel === 'molmim') {
            const smi = document.getElementById('inp-smiles').value;
            if(!smi) return alert("SMILES required");
            payload = { smiles: smi };
        }
        else if (currentModel === 'diffdock') {
            const pdb = document.getElementById('inp-pdb').value;
            const lig = document.getElementById('inp-ligand').value;
            if(!pdb || !lig) return alert("Both PDB and Ligand required");
            payload = { pdb_string: pdb, smiles: lig };
        }

        // State Update
        btn.disabled = true;
        loader.style.display = 'flex';

        try {
            const res = await fetch(`/predict/${currentModel}`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            
            if(data.error) throw new Error(data.error);
            if(!data.data) throw new Error("No structure returned");

            // Success
            currentData = data.data;
            currentExt = data.type;
            loadStructure(data.data, data.type);

        } catch(e) {
            alert("Execution Failed: " + e.message);
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
        }
    }

    // --- VISUALIZATION ---
    function loadStructure(dataStr, type) {
        stage.removeAllComponents();
        const blob = new Blob([dataStr], {type: 'text/plain'});

        stage.loadFile(blob, { ext: type }).then(c => {
            comp = c;
            comp.removeAllRepresentations();

            if (currentModel === 'molmim') {
                // Chemistry Style
                comp.addRepresentation("ball+stick", { multipleBond: "symmetric" });
            } 
            else if (currentModel === 'diffdock') {
                // Docking Style
                comp.addRepresentation("licorice", { colorScheme:"element" });
            }
            else {
                // Protein Style
                comp.addRepresentation("cartoon", { colorScheme:"residueindex", quality:"high" });
            }
            
            stage.autoView(1000);
        });
    }

    // --- CONTROLS ---
    function resetView() { stage.autoView(1000); }
    
    function toggleSpin() {
        isSpinning = !isSpinning;
        stage.setSpin(isSpinning);
    }

    function takeScreenshot() {
        stage.makeImage({ factor: 2, antialias: true, trim: false }).then(b => {
            NGL.download(b, "bionemo_render.png");
        });
    }

    // --- FIXED DOWNLOAD FUNCTION ---
    function downloadData() {
        if(!currentData) return;
        const blob = new Blob([currentData], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `result.${currentExt}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

</script>
</body>
</html>